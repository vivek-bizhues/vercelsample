"use strict";(()=>{var e={};e.id=877,e.ids=[877],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},55795:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>q,originalPathname:()=>k,requestAsyncStorage:()=>x,routeModule:()=>y,serverHooks:()=>f,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>E});var a={};r.r(a),r.d(a,{POST:()=>w}),r(95655);var s=r(83323),i=r(54647),o=r(66886),n=r(59859),c=r(74848);let d=new c.Z(process.env.STRIPE_SECRET_KEY??"",{apiVersion:"2023-08-16",appInfo:{name:"ai2saas",version:"0.1.0"}});var u=r(63433);let p=e=>{var t=new Date("1970-01-01T00:30:00Z");return t.setSeconds(e),t},l=(0,u.createClient)("https://uazpvkwuzvgyyfouwqoc.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||""),_=async e=>{let t={id:e.id,active:e.active,name:e.name,description:e.description??void 0,image:e.images?.[0]??null,metadata:e.metadata},{error:r}=await l.from("products").upsert([t]);if(r)throw r;console.log(`Product inserted/updated: ${e.id}`)},m=async e=>{let t={id:e.id,product_id:"string"==typeof e.product?e.product:"",active:e.active,currency:e.currency,description:e.nickname??void 0,type:e.type,unit_amount:e.unit_amount??void 0,interval:e.recurring?.interval,interval_count:e.recurring?.interval_count,trial_period_days:e.recurring?.trial_period_days,metadata:e.metadata},{error:r}=await l.from("prices").upsert([t]);if(r)throw r;console.log(`Price inserted/updated: ${e.id}`)},h=async(e,t)=>{let r=t.customer,{name:a,phone:s,address:i}=t.billing_details;if(!a||!s||!i)return;await d.customers.update(r,{name:a,phone:s,address:i});let{error:o}=await l.from("users").update({billing_address:{...i},payment_method:{...t[t.type]}}).eq("id",e);if(o)throw o},g=async(e,t,r=!1)=>{let{data:a,error:s}=await l.from("customers").select("id").eq("stripe_customer_id",t).single();if(s)throw s;let{id:i}=a,o=await d.subscriptions.retrieve(e,{expand:["default_payment_method"]}),n={id:o.id,user_id:i,metadata:o.metadata,status:o.status,price_id:o.items.data[0].price.id,quantity:o.quantity,cancel_at_period_end:o.cancel_at_period_end,cancel_at:o.cancel_at?p(o.cancel_at).toISOString():null,canceled_at:o.canceled_at?p(o.canceled_at).toISOString():null,current_period_start:p(o.current_period_start).toISOString(),current_period_end:p(o.current_period_end).toISOString(),created:p(o.created).toISOString(),ended_at:o.ended_at?p(o.ended_at).toISOString():null,trial_start:o.trial_start?p(o.trial_start).toISOString():null,trial_end:o.trial_end?p(o.trial_end).toISOString():null},{error:c}=await l.from("subscriptions").upsert([n]);if(c)throw c;console.log(`Inserted/updated subscription [${o.id}] for user [${i}]`),r&&o.default_payment_method&&i&&await h(i,o.default_payment_method)},b=new Set(["product.created","product.updated","price.created","price.updated","checkout.session.completed","customer.subscription.created","customer.subscription.updated","customer.subscription.deleted"]);async function w(e){let t;let r=await e.text(),a=(0,n.headers)().get("Stripe-Signature"),s=process.env.STRIPE_WEBHOOK_SECRET_LIVE??process.env.STRIPE_WEBHOOK_SECRET;try{t=d.webhooks.constructEvent(r,a,s)}catch(e){return console.log(`❌ Error message: ${e.message}`),new o.Z(`Webhook Error: ${e.message}`,{status:400})}if(b.has(t.type))try{switch(t.type){case"product.created":case"product.updated":await _(t.data.object);break;case"price.created":case"price.updated":await m(t.data.object);break;case"customer.subscription.created":case"customer.subscription.updated":case"customer.subscription.deleted":let e=t.data.object;await g(e.id,e.customer,"customer.subscription.created"===t.type);break;case"checkout.session.completed":let r=t.data.object;if("subscription"===r.mode){let e=r.subscription;await g(e,r.customer,!0)}break;default:throw Error("Unhandled relevant event!")}}catch(e){return console.log(e),new o.Z('Webhook error: "Webhook handler failed. View logs."',{status:400})}return o.Z.json({received:!0},{status:200})}let v=s.AppRouteRouteModule,y=new v({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/route",pathname:"/api/webhooks",filename:"route",bundlePath:"app/api/webhooks/route"},resolvedPagePath:"/home/bizhueslabs/WorkSpace/vercelsample/src/app/api/webhooks/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:S,serverHooks:f,headerHooks:q,staticGenerationBailout:E}=y,k="/api/webhooks/route"}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[650,506,727,854],()=>r(55795));module.exports=a})();